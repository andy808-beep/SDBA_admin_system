#!/usr/bin/env node

/**
 * Test script for admin API endpoints
 * Inserts test data and verifies API functionality
 */

import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';

// Load environment variables
dotenv.config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in .env.local');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey, {
  auth: { persistSession: false }
});

// Get current season (2025)
const currentSeason = new Date().getFullYear();

async function insertTestData() {
  console.log('ğŸ“ Inserting test data into registration_meta...\n');

  // Test data for TN/L (ladies)
  const tnLadies = {
    season: currentSeason,
    event_type: 'tn',
    category: 'ladies_open',
    division_code: 'L',
    option_choice: 'Option 1',
    team_code: '', // Will be auto-generated by trigger
    team_name: 'Test Ladies Team',
    org_name: 'Test Organization',
    org_address: '123 Test Street',
    team_manager_1: 'Jane Manager',
    mobile_1: '1234567890',
    email_1: 'jane@test.com',
    team_manager_2: 'Jane Assistant',
    mobile_2: null,
    email_2: null,
    status: 'pending',
  };

  // Test data for WU/WX
  const wuTeam = {
    season: currentSeason,
    event_type: 'wu',
    division_code: 'WX',
    team_code: '', // Will be auto-generated by trigger
    team_name: 'Test WU Team',
    org_name: 'Test Organization',
    org_address: '123 Test Street',
    team_manager_1: 'John Manager',
    mobile_1: '1234567890',
    email_1: 'john@test.com',
    team_manager_2: 'John Assistant',
    mobile_2: null,
    email_2: null,
    package_choice: 'basic_wu',
    team_size: 15,
    status: 'pending',
  };

  // Test data for SC/SM
  const scTeam = {
    season: currentSeason,
    event_type: 'sc',
    division_code: 'SM',
    team_code: '', // Will be auto-generated by trigger
    team_name: 'Test SC Team',
    org_name: 'Test Organization',
    org_address: '123 Test Street',
    team_manager_1: 'Bob Manager',
    mobile_1: '1234567890',
    email_1: 'bob@test.com',
    team_manager_2: 'Bob Assistant',
    mobile_2: null,
    email_2: null,
    package_choice: 'basic_sc',
    team_size: 12,
    status: 'pending',
  };

  try {
    // Insert TN/L
    const { data: tnData, error: tnError } = await supabase
      .from('registration_meta')
      .insert([tnLadies])
      .select('id, team_code')
      .single();

    if (tnError) {
      console.error('âŒ Error inserting TN/L:', tnError.message);
      return null;
    }
    console.log('âœ… Inserted TN/L:', tnData.id, 'Team Code:', tnData.team_code);

    // Insert WU/WX
    const { data: wuData, error: wuError } = await supabase
      .from('registration_meta')
      .insert([wuTeam])
      .select('id, team_code')
      .single();

    if (wuError) {
      console.error('âŒ Error inserting WU/WX:', wuError.message);
      return null;
    }
    console.log('âœ… Inserted WU/WX:', wuData.id, 'Team Code:', wuData.team_code);

    // Insert SC/SM
    const { data: scData, error: scError } = await supabase
      .from('registration_meta')
      .insert([scTeam])
      .select('id, team_code')
      .single();

    if (scError) {
      console.error('âŒ Error inserting SC/SM:', scError.message);
      return null;
    }
    console.log('âœ… Inserted SC/SM:', scData.id, 'Team Code:', scData.team_code);

    return { tnId: tnData.id, wuId: wuData.id, scId: scData.id };
  } catch (error) {
    console.error('âŒ Error inserting test data:', error);
    return null;
  }
}

async function testAPIWithoutAuth() {
  console.log('\nğŸ”’ Testing API endpoints without auth (should return 403)...\n');

  try {
    // Test /api/admin/list without auth
    const listResponse = await fetch('http://localhost:3000/api/admin/list?page=1&pageSize=2&status=pending');
    const listData = await listResponse.json();
    
    if (listResponse.status === 403 && listData.error === 'Forbidden') {
      console.log('âœ… /api/admin/list correctly returns 403 without auth');
    } else {
      console.error('âŒ /api/admin/list should return 403, got:', listResponse.status, listData);
    }

    // Test /api/admin/counters without auth
    const countersResponse = await fetch('http://localhost:3000/api/admin/counters');
    const countersData = await countersResponse.json();
    
    if (countersResponse.status === 403 && countersData.error === 'Forbidden') {
      console.log('âœ… /api/admin/counters correctly returns 403 without auth');
    } else {
      console.error('âŒ /api/admin/counters should return 403, got:', countersResponse.status, countersData);
    }
  } catch (error) {
    console.error('âŒ Error testing API without auth:', error.message);
    console.log('   (This is expected if the dev server is not running)');
  }
}

async function verifyData() {
  console.log('\nğŸ“Š Verifying inserted data...\n');

  try {
    // Count pending registrations
    const { count, error } = await supabase
      .from('registration_meta')
      .select('*', { count: 'exact', head: true })
      .eq('status', 'pending');

    if (error) {
      console.error('âŒ Error counting pending:', error.message);
      return;
    }

    console.log(`ğŸ“ˆ Total pending registrations: ${count || 0}`);
    
    // List pending registrations
    const { data, error: listError } = await supabase
      .from('registration_meta')
      .select('id, event_type, division_code, team_name, team_code, status')
      .eq('status', 'pending')
      .order('created_at', { ascending: false });

    if (listError) {
      console.error('âŒ Error listing pending:', listError.message);
      return;
    }

    console.log('\nğŸ“‹ Pending registrations:');
    data?.forEach((reg, idx) => {
      console.log(`   ${idx + 1}. ${reg.event_type.toUpperCase()}/${reg.division_code || 'N/A'} - ${reg.team_name} (${reg.id.substring(0, 8)}...)`);
    });

    return data?.length || 0;
  } catch (error) {
    console.error('âŒ Error verifying data:', error);
    return 0;
  }
}

async function main() {
  console.log('ğŸ§ª Admin API Testing Script\n');
  console.log('='.repeat(50));

  // Insert test data
  const inserted = await insertTestData();
  if (!inserted) {
    console.error('Failed to insert test data. Exiting.');
    process.exit(1);
  }

  // Verify data
  const pendingCount = await verifyData();
  
  if (pendingCount < 3) {
    console.warn(`âš ï¸  Expected at least 3 pending registrations, found ${pendingCount}`);
  }

  // Test APIs without auth
  await testAPIWithoutAuth();

  console.log('\n' + '='.repeat(50));
  console.log('âœ… Test data inserted successfully!');
  console.log('\nğŸ“ Next steps:');
  console.log('   1. Start the dev server: npm run dev');
  console.log('   2. Login as admin and test:');
  console.log('      - /admin#applications should show 3 rows');
  console.log('      - /admin#overview should show counters');
  console.log('      - Approve one registration and verify it moves to team_meta');
  console.log('      - Test badge increment by inserting a new pending registration');
  console.log('\nğŸ’¡ To test API endpoints with auth, use the browser developer tools');
  console.log('   and copy the session cookie, then use it in curl/Postman requests.');
}

main().catch(console.error);

