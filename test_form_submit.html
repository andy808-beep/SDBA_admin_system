<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TN Form Submit Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { background: #f8f9fa; padding: 10px; border-left: 4px solid #007bff; margin: 10px 0; }
        .error-log { border-left-color: #dc3545; }
        .success-log { border-left-color: #28a745; }
    </style>
</head>
<body>
    <h1>üß™ TN Form Submit Test</h1>
    
    <div class="test-section info">
        <h3>Test Instructions</h3>
        <p>This test verifies the TN form submission with the hooked submit event:</p>
        <ul>
            <li><strong>Payload Shape:</strong> Verifies exact payload structure matches server expectations</li>
            <li><strong>Client TX ID:</strong> Tests deterministic client transaction ID generation</li>
            <li><strong>Edge Function Call:</strong> Tests sb.functions.invoke call</li>
            <li><strong>Error Handling:</strong> Tests duplicate team name error handling</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="checkFunctionAvailability()">Check Function Availability</button>
        <button onclick="testPayloadGeneration()">Test Payload Generation</button>
        <button onclick="testClientTxId()">Test Client TX ID</button>
        <button onclick="testEdgeFunctionSimple()">Test Edge Function Simple</button>
        <button onclick="testEdgeFunctionDirect()">Test Edge Function Direct</button>
        <button onclick="testFormSubmission()">Test Form Submission</button>
        <button onclick="testDuplicateError()">Test Duplicate Error</button>
        <button onclick="testDOMSelectors()">Test DOM Selectors</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>

    <!-- Create minimal DOM structure for TN wizard initialization -->
    <div id="tnScope" style="display: none;">
        <div id="wizardMount">
            <div id="stepper"></div>
        </div>
    </div>

    <!-- Add required DOM elements for selector testing -->
    <div id="domTestElements" style="display: none;">
        <!-- Team name elements -->
        <div class="teamName">Test Team 1</div>
        <div class="teamName">Test Team 2</div>
        
        <!-- Practice team elements with required children -->
        <div class="practiceTeam">
            <div class="prefRow">
                <span>Practice Date: 2025-01-15</span>
                <span>Duration: 2 hours</span>
            </div>
            <div class="slotRank">
                <span>Rank 1: SAT2_0800_1000</span>
            </div>
        </div>
        
        <div class="practiceTeam">
            <div class="prefRow">
                <span>Practice Date: 2025-01-16</span>
                <span>Duration: 2 hours</span>
            </div>
            <div class="slotRank">
                <span>Rank 1: SUN2_0900_1100</span>
            </div>
        </div>
    </div>

    <!-- Load environment configuration first -->
    <script src="public/env.js"></script>
    
    <!-- Load other scripts as modules -->
    <script type="module">
        // Import the required modules
        import { sb } from './public/supabase_config.js';
        import { getClientTxId, getEventShortRef, postJSON, saveReceipt, showConfirmation, mapError } from './public/js/submit.js';
        import { readTeamRows, readTeamRanks } from './public/js/tn_practice_store.js';
        
        // Make them available globally for testing
        window.sb = sb;
        window.getClientTxId = getClientTxId;
        window.getEventShortRef = getEventShortRef;
        window.postJSON = postJSON;
        window.saveReceipt = saveReceipt;
        window.showConfirmation = showConfirmation;
        window.mapError = mapError;
        window.readTeamRows = readTeamRows;
        window.readTeamRanks = readTeamRanks;
        
        // Load the TN wizard module
        const tnModule = await import('./public/js/tn_wizard.js');
        
        // Initialize the TN wizard
        if (tnModule.initTNWizard) {
            tnModule.initTNWizard();
        }
        
        // Wait a bit for the TN wizard to initialize
        setTimeout(() => {
            console.log('üéØ Available functions after module load:');
            console.log('  - collectContactData:', typeof window.collectContactData);
            console.log('  - collectTeamData:', typeof window.collectTeamData);
            console.log('  - collectManagerData:', typeof window.collectManagerData);
            console.log('  - collectRaceDayData:', typeof window.collectRaceDayData);
            console.log('  - buildTNPracticePayload:', typeof window.buildTNPracticePayload);
            console.log('  - submitTNForm:', typeof window.submitTNForm);
            console.log('  - getClientTxId:', typeof window.getClientTxId);
            console.log('  - sb:', typeof window.sb);
            
            // Check if functions are available and log status
            const functionsAvailable = typeof window.collectContactData === 'function';
            if (functionsAvailable) {
                console.log('‚úÖ All TN wizard functions are now available!');
            } else {
                console.log('‚ùå TN wizard functions are still not available. Check initialization.');
            }
        }, 2000);
    </script>
    
    <script>
        // Set up test environment
        window.__CONFIG = {
            event: {
                event_short_ref: 'TN2025',
                season: 2025
            },
            practice: {
                practice_start_date: '2025-01-01',
                practice_end_date: '2025-07-31',
                allowed_weekdays: [1, 2, 3, 4, 5, 6, 0] // All days
            },
            divisions: [
                { division_code: 'X', name_en: 'Mixed Open' }
            ],
            packages: [
                { package_code: 'option_1_non_corp', title_en: 'Option 1' },
                { package_code: 'option_2_non_corp', title_en: 'Option 2' }
            ]
        };
        
        // Enable practice mode
        window.__PRACTICE_ENABLED = true;

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}-log`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            logsDiv.appendChild(logDiv);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function checkFunctionAvailability() {
            log('üîç Checking function availability...', 'info');
            
            const functions = [
                'collectContactData',
                'collectTeamData', 
                'collectManagerData',
                'collectRaceDayData',
                'collectPackageData',
                'buildTNPracticePayload',
                'submitTNForm',
                'getClientTxId',
                'sb'
            ];
            
            let allAvailable = true;
            functions.forEach(funcName => {
                const available = typeof window[funcName] === 'function' || typeof window[funcName] === 'object';
                const status = available ? '‚úÖ' : '‚ùå';
                log(`${status} ${funcName}: ${typeof window[funcName]}`, available ? 'success' : 'error');
                if (!available) allAvailable = false;
            });
            
            if (allAvailable) {
                log('üéâ All functions are available! You can now run the tests.', 'success');
            } else {
                log('‚ö†Ô∏è Some functions are missing. Please wait for modules to load completely.', 'error');
            }
        }

        function testPayloadGeneration() {
            log('üß™ Testing payload generation...', 'info');
            
            // Check if functions are available
            if (typeof window.collectContactData !== 'function') {
                log('‚ùå Functions not loaded yet. Please wait for modules to load.', 'error');
                return;
            }
            
            try {
                // Set up test data in sessionStorage
                sessionStorage.setItem('tn_race_category', 'mixed_open');
                sessionStorage.setItem('tn_team_count', '2');
                sessionStorage.setItem('tn_opt1_count', '1');
                sessionStorage.setItem('tn_opt2_count', '1');
                sessionStorage.setItem('tn_org_name', 'Test Organization');
                sessionStorage.setItem('tn_mailing_address', '123 Test Street, Test City');
                
                // Team data
                sessionStorage.setItem('tn_team_name_1', 'Test Team 1');
                sessionStorage.setItem('tn_team_category_1', 'mixed_open');
                sessionStorage.setItem('tn_team_option_1', 'opt1');
                sessionStorage.setItem('tn_team_name_2', 'Test Team 2');
                sessionStorage.setItem('tn_team_category_2', 'mixed_open');
                sessionStorage.setItem('tn_team_option_2', 'opt2');
                
                // Manager data
                sessionStorage.setItem('tn_manager1_name', 'Manager One');
                sessionStorage.setItem('tn_manager1_phone', '123-456-7890');
                sessionStorage.setItem('tn_manager1_email', 'manager1@test.com');
                sessionStorage.setItem('tn_manager2_name', 'Manager Two');
                sessionStorage.setItem('tn_manager2_phone', '234-567-8901');
                sessionStorage.setItem('tn_manager2_email', 'manager2@test.com');
                sessionStorage.setItem('tn_manager3_name', 'Manager Three');
                sessionStorage.setItem('tn_manager3_phone', '345-678-9012');
                sessionStorage.setItem('tn_manager3_email', 'manager3@test.com');
                
                // Race day data
                const raceDayData = {
                    marqueeQty: 1,
                    steerWithQty: 0,
                    steerWithoutQty: 1,
                    junkBoatQty: 0,
                    junkBoatNo: '',
                    speedboatQty: 1,
                    speedBoatNo: 'SB123'
                };
                sessionStorage.setItem('tn_race_day', JSON.stringify(raceDayData));
                
                // Mock practice data
                window.readTeamRows = function(teamKey) {
                    const teamIndex = parseInt(teamKey.replace('t', '')) - 1;
                    const mockData = [
                        [
                            { pref_date: '2025-01-15', duration_hours: 2, helper: 'ST' },
                            { pref_date: '2025-01-22', duration_hours: 1, helper: 'S' }
                        ],
                        [
                            { pref_date: '2025-01-16', duration_hours: 2, helper: 'T' }
                        ]
                    ];
                    return mockData[teamIndex] || [];
                };
                
                window.readTeamRanks = function(teamKey) {
                    const teamIndex = parseInt(teamKey.replace('t', '')) - 1;
                    const mockData = [
                        [
                            { rank: 1, slot_code: 'SAT2_0800_1000' },
                            { rank: 2, slot_code: 'SAT2_1000_1200' },
                            { rank: 3, slot_code: 'SAT1_0800_0900' }
                        ],
                        [
                            { rank: 1, slot_code: 'SUN2_0900_1100' }
                        ]
                    ];
                    return mockData[teamIndex] || [];
                };
                
                // Test the payload generation by calling the collection functions
                const contact = window.collectContactData();
                const teams = window.collectTeamData();
                const managers = window.collectManagerData();
                const raceDay = window.collectRaceDayData();
                const practice = window.buildTNPracticePayload();
                
                log(`‚úÖ Contact data: ${JSON.stringify(contact)}`, 'success');
                log(`‚úÖ Teams data: ${JSON.stringify(teams)}`, 'success');
                log(`‚úÖ Managers data: ${JSON.stringify(managers)}`, 'success');
                log(`‚úÖ Race day data: ${JSON.stringify(raceDay)}`, 'success');
                log(`‚úÖ Practice data: ${JSON.stringify(practice)}`, 'success');
                
                // Test full payload
                const payload = {
                    client_tx_id: window.getClientTxId(),
                    eventShortRef: window.getEventShortRef() || 'TN2025',
                    category: 'mixed_open',
                    season: 2025,
                    org_name: contact.name,
                    org_address: contact.address,
                    counts: {
                        num_teams: 2,
                        num_teams_opt1: 1,
                        num_teams_opt2: 1
                    },
                    team_names: teams.map(t => t.name),
                    team_options: teams.map(t => t.option),
                    managers: managers,
                    race_day: raceDay.length > 0 ? {
                        marqueeQty: raceDay.find(r => r.code === 'marquee')?.qty || 0,
                        steerWithQty: raceDay.find(r => r.code === 'steer_with')?.qty || 0,
                        steerWithoutQty: raceDay.find(r => r.code === 'steer_without')?.qty || 0,
                        junkBoatQty: raceDay.find(r => r.code === 'junk_boat')?.qty || 0,
                        junkBoatNo: raceDay.find(r => r.code === 'junk_boat')?.boat_no || '',
                        speedboatQty: raceDay.find(r => r.code === 'speed_boat')?.qty || 0,
                        speedBoatNo: raceDay.find(r => r.code === 'speed_boat')?.boat_no || ''
                    } : null,
                    practice: practice
                };
                
                log(`‚úÖ Full payload generated: ${JSON.stringify(payload, null, 2)}`, 'success');
                
            } catch (error) {
                log(`‚ùå Payload generation failed: ${error.message}`, 'error');
            }
        }

        function testClientTxId() {
            log('üß™ Testing client transaction ID generation...', 'info');
            
            // Check if functions are available
            if (typeof window.getClientTxId !== 'function') {
                log('‚ùå Functions not loaded yet. Please wait for modules to load.', 'error');
                return;
            }
            
            try {
                // Clear existing ID to test generation
                localStorage.removeItem('raceApp:client_tx_id');
                
                const id1 = window.getClientTxId();
                const id2 = window.getClientTxId();
                
                log(`‚úÖ First ID: ${id1}`, 'success');
                log(`‚úÖ Second ID: ${id2}`, 'success');
                
                if (id1 === id2) {
                    log(`‚úÖ IDs are deterministic (same)`, 'success');
                } else {
                    log(`‚ùå IDs are not deterministic (different)`, 'error');
                }
                
                // Test UUID format
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (uuidRegex.test(id1)) {
                    log(`‚úÖ ID is valid UUID format`, 'success');
                } else {
                    log(`‚ùå ID is not valid UUID format`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Client TX ID test failed: ${error.message}`, 'error');
            }
        }

        async function testEdgeFunctionSimple() {
            log('üß™ Testing Edge Function with minimal payload...', 'info');
            
            try {
                // Test with absolute minimal payload using unique team name
                const timestamp = Date.now();
                const minimalPayload = {
                    eventShortRef: 'TN2025',
                    category: 'mixed_open',
                    org_name: `Test Org ${timestamp}`,
                    counts: {
                        num_teams: 1,
                        num_teams_opt1: 1,
                        num_teams_opt2: 0
                    },
                    team_names: [`Test Team ${timestamp}`],
                    team_options: ['opt1'],
                    managers: [
                        { name: `Test Manager ${timestamp}`, mobile: '123-456-7890', email: `test${timestamp}@example.com` }
                    ]
                };
                
                log(`üì§ Sending minimal payload: ${JSON.stringify(minimalPayload, null, 2)}`, 'info');
                
                const response = await fetch('https://khqarcvszewerjckmtpg.supabase.co/functions/v1/submit_registration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.ENV.SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(minimalPayload)
                });
                
                const responseText = await response.text();
                log(`üì° Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`üì° Response body: ${responseText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    try {
                        const responseJson = JSON.parse(responseText);
                        log(`‚úÖ Parsed success response: ${JSON.stringify(responseJson, null, 2)}`, 'success');
                    } catch (parseError) {
                        log(`‚úÖ Raw success response: ${responseText}`, 'success');
                    }
                } else {
                    try {
                        const errorJson = JSON.parse(responseText);
                        log(`‚ùå Parsed error response: ${JSON.stringify(errorJson, null, 2)}`, 'error');
                    } catch (parseError) {
                        log(`‚ùå Raw error response: ${responseText}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Simple Edge Function test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testEdgeFunctionDirect() {
            log('üß™ Testing Edge Function directly...', 'info');
            
            // Check if Supabase client is available
            if (!window.sb || !window.sb.functions) {
                log('‚ùå Supabase client not available', 'error');
                return;
            }
            
            try {
                // Create a simple test payload with unique team names
                const timestamp = Date.now();
                const testPayload = {
                    client_tx_id: 'test-direct-' + timestamp,
                    eventShortRef: 'TN2025',
                    category: 'mixed_open',
                    season: 2025,
                    org_name: `Test Organization ${timestamp}`,
                    org_address: '123 Test Street, Test City',
                    counts: {
                        num_teams: 2,
                        num_teams_opt1: 1,
                        num_teams_opt2: 1
                    },
                    team_names: [`Test Team 1 ${timestamp}`, `Test Team 2 ${timestamp}`],
                    team_options: ['opt1', 'opt2'],
                    managers: [
                        { name: `Manager One ${timestamp}`, mobile: '123-456-7890', email: `manager1${timestamp}@test.com` },
                        { name: `Manager Two ${timestamp}`, mobile: '234-567-8901', email: `manager2${timestamp}@test.com` }
                    ],
                    race_day: {
                        marqueeQty: 1,
                        steerWithQty: 0,
                        steerWithoutQty: 1,
                        junkBoatQty: 0,
                        junkBoatNo: '',
                        speedboatQty: 1,
                        speedBoatNo: 'SB123'
                    },
                    practice: {
                        teams: [
                            {
                                team_key: 't1',
                                dates: [
                                    { pref_date: '2025-01-15', duration_hours: 2, helper: 'ST' }
                                ],
                                slot_ranks: [
                                    { rank: 1, slot_code: 'SAT2_0800_1000' }
                                ]
                            },
                            {
                                team_key: 't2',
                                dates: [
                                    { pref_date: '2025-01-16', duration_hours: 2, helper: 'T' }
                                ],
                                slot_ranks: [
                                    { rank: 1, slot_code: 'SUN2_0900_1100' }
                                ]
                            }
                        ]
                    }
                };
                
                log(`üì§ Sending payload: ${JSON.stringify(testPayload, null, 2)}`, 'info');
                
                // Call the Edge Function directly
                try {
                    const { data, error } = await window.sb.functions.invoke('submit_registration', {
                        body: testPayload
                    });
                    
                    if (error) {
                        log(`‚ùå Edge Function error: ${JSON.stringify(error, null, 2)}`, 'error');
                        console.error('Full error details:', error);
                    } else {
                        log(`‚úÖ Edge Function success: ${JSON.stringify(data, null, 2)}`, 'success');
                    }
                } catch (invokeError) {
                    log(`‚ùå Invoke error: ${invokeError.message}`, 'error');
                    console.error('Invoke error details:', invokeError);
                    
                    // Try to get more details by calling the function with different parameters
                    try {
                        const response = await fetch('https://khqarcvszewerjckmtpg.supabase.co/functions/v1/submit_registration', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${window.ENV.SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify(testPayload)
                        });
                        
                        const responseText = await response.text();
                        log(`üì° Direct fetch response (${response.status}): ${responseText}`, 'error');
                        
                        try {
                            const responseJson = JSON.parse(responseText);
                            log(`üì° Parsed response: ${JSON.stringify(responseJson, null, 2)}`, 'error');
                        } catch (parseError) {
                            log(`üì° Raw response (not JSON): ${responseText}`, 'error');
                        }
                    } catch (fetchError) {
                        log(`‚ùå Direct fetch failed: ${fetchError.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Direct Edge Function test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        function testFormSubmission() {
            log('üß™ Testing form submission...', 'info');
            
            // Check if functions are available
            if (typeof window.submitTNForm !== 'function') {
                log('‚ùå Functions not loaded yet. Please wait for modules to load.', 'error');
                return;
            }
            
            try {
                // Set up test data first with unique names
                const timestamp = Date.now();
                sessionStorage.setItem('tn_race_category', 'mixed_open');
                sessionStorage.setItem('tn_team_count', '2');
                sessionStorage.setItem('tn_opt1_count', '1');
                sessionStorage.setItem('tn_opt2_count', '1');
                sessionStorage.setItem('tn_org_name', `Test Organization ${timestamp}`);
                sessionStorage.setItem('tn_mailing_address', '123 Test Street, Test City');
                
                // Team data
                sessionStorage.setItem('tn_team_name_1', `Test Team 1 ${timestamp}`);
                sessionStorage.setItem('tn_team_category_1', 'mixed_open');
                sessionStorage.setItem('tn_team_option_1', 'opt1');
                sessionStorage.setItem('tn_team_name_2', `Test Team 2 ${timestamp}`);
                sessionStorage.setItem('tn_team_category_2', 'mixed_open');
                sessionStorage.setItem('tn_team_option_2', 'opt2');
                
                // Manager data
                sessionStorage.setItem('tn_manager1_name', `Manager One ${timestamp}`);
                sessionStorage.setItem('tn_manager1_phone', '123-456-7890');
                sessionStorage.setItem('tn_manager1_email', `manager1${timestamp}@test.com`);
                sessionStorage.setItem('tn_manager2_name', `Manager Two ${timestamp}`);
                sessionStorage.setItem('tn_manager2_phone', '234-567-8901');
                sessionStorage.setItem('tn_manager2_email', `manager2${timestamp}@test.com`);
                
                // Race day data
                const raceDayData = {
                    marqueeQty: 1,
                    steerWithQty: 0,
                    steerWithoutQty: 1,
                    junkBoatQty: 0,
                    junkBoatNo: '',
                    speedboatQty: 1,
                    speedBoatNo: 'SB123'
                };
                sessionStorage.setItem('tn_race_day', JSON.stringify(raceDayData));
                
                // Mock practice functions
                window.readTeamRows = function(teamKey) {
                    const teamIndex = parseInt(teamKey.replace('t', '')) - 1;
                    const mockData = [
                        [{ pref_date: '2025-01-15', duration_hours: 2, helper: 'ST' }],
                        [{ pref_date: '2025-01-16', duration_hours: 2, helper: 'T' }]
                    ];
                    return mockData[teamIndex] || [];
                };
                
                window.readTeamRanks = function(teamKey) {
                    const teamIndex = parseInt(teamKey.replace('t', '')) - 1;
                    const mockData = [
                        [{ rank: 1, slot_code: 'SAT2_0800_1000' }],
                        [{ rank: 1, slot_code: 'SUN2_0900_1100' }]
                    ];
                    return mockData[teamIndex] || [];
                };
                
                // Test the actual submitTNForm function
                log('üì§ Calling submitTNForm...', 'info');
                
                // Call the real function
                window.submitTNForm().then((result) => {
                    log('‚úÖ submitTNForm completed successfully', 'success');
                    if (result) {
                        log(`üìã Result: ${JSON.stringify(result, null, 2)}`, 'success');
                    }
                }).catch((error) => {
                    log(`‚ùå submitTNForm failed: ${error.message}`, 'error');
                    console.error('Full error:', error);
                });
                
            } catch (error) {
                log(`‚ùå Form submission test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        function testDOMSelectors() {
            log('üß™ Testing DOM selectors...', 'info');
            
            try {
                // Test .teamName selector
                const teamNameElements = document.querySelectorAll('.teamName');
                const teamNameCount = teamNameElements.length;
                log(`üìã .teamName elements found: ${teamNameCount}`, teamNameCount > 0 ? 'success' : 'error');
                
                if (teamNameCount > 0) {
                    teamNameElements.forEach((el, index) => {
                        log(`  - Team ${index + 1}: "${el.textContent}"`, 'success');
                    });
                }
                
                // Test .practiceTeam selector
                const practiceTeamElements = document.querySelectorAll('.practiceTeam');
                const practiceTeamCount = practiceTeamElements.length;
                log(`üìã .practiceTeam elements found: ${practiceTeamCount}`, practiceTeamCount > 0 ? 'success' : 'error');
                
                if (practiceTeamCount > 0) {
                    practiceTeamElements.forEach((team, teamIndex) => {
                        log(`  - Practice Team ${teamIndex + 1}:`, 'info');
                        
                        // Check for .prefRow children
                        const prefRows = team.querySelectorAll('.prefRow');
                        log(`    - .prefRow children: ${prefRows.length}`, prefRows.length > 0 ? 'success' : 'error');
                        
                        // Check for .slotRank children
                        const slotRanks = team.querySelectorAll('.slotRank');
                        log(`    - .slotRank children: ${slotRanks.length}`, slotRanks.length > 0 ? 'success' : 'error');
                        
                        // Verify at least one practiceTeam has both .prefRow and .slotRank
                        if (prefRows.length > 0 && slotRanks.length > 0) {
                            log(`    ‚úÖ Practice Team ${teamIndex + 1} has both .prefRow and .slotRank children`, 'success');
                        } else {
                            log(`    ‚ùå Practice Team ${teamIndex + 1} missing required children`, 'error');
                        }
                    });
                }
                
                // Summary
                const hasTeamNames = teamNameCount > 0;
                const hasPracticeTeams = practiceTeamCount > 0;
                const hasValidPracticeTeam = Array.from(practiceTeamElements).some(team => 
                    team.querySelectorAll('.prefRow').length > 0 && 
                    team.querySelectorAll('.slotRank').length > 0
                );
                
                log('üìä DOM Selector Test Summary:', 'info');
                log(`  - .teamName elements: ${teamNameCount} ${hasTeamNames ? '‚úÖ' : '‚ùå'}`, hasTeamNames ? 'success' : 'error');
                log(`  - .practiceTeam elements: ${practiceTeamCount} ${hasPracticeTeams ? '‚úÖ' : '‚ùå'}`, hasPracticeTeams ? 'success' : 'error');
                log(`  - Valid practice team (has both .prefRow and .slotRank): ${hasValidPracticeTeam ? '‚úÖ' : '‚ùå'}`, hasValidPracticeTeam ? 'success' : 'error');
                
                if (hasTeamNames && hasPracticeTeams && hasValidPracticeTeam) {
                    log('üéâ All DOM selectors are present and valid!', 'success');
                } else {
                    log('‚ùå Some DOM selectors are missing or invalid', 'error');
                }
                
            } catch (error) {
                log(`‚ùå DOM selector test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        function testDuplicateError() {
            log('üß™ Testing duplicate error handling...', 'info');
            
            try {
                // Test error message parsing
                const testErrors = [
                    {
                        message: 'duplicate key value violates unique constraint "uniq_teamname_per_div_season_norm"',
                        expected: 'One or more team names already exist for this division and season. Please choose different team names.'
                    },
                    {
                        message: 'duplicate key value violates unique constraint "uniq_registration_client_tx"',
                        expected: 'This registration has already been submitted. Please refresh the page to start a new registration.'
                    },
                    {
                        message: 'duplicate key value violates unique constraint "some_other_constraint"',
                        expected: 'Duplicate data detected. Please check your team names and try again.'
                    },
                    {
                        message: 'Some other error',
                        expected: 'Submission failed: Some other error'
                    }
                ];
                
                testErrors.forEach((testCase, index) => {
                    const error = { message: testCase.message };
                    let expectedMessage = '';
                    
                    if (error.message && error.message.includes('duplicate key value violates unique constraint')) {
                        if (error.message.includes('uniq_teamname_per_div_season_norm')) {
                            expectedMessage = 'One or more team names already exist for this division and season. Please choose different team names.';
                        } else if (error.message.includes('uniq_registration_client_tx')) {
                            expectedMessage = 'This registration has already been submitted. Please refresh the page to start a new registration.';
                        } else {
                            expectedMessage = 'Duplicate data detected. Please check your team names and try again.';
                        }
                    } else {
                        expectedMessage = `Submission failed: ${error.message || 'Unknown error'}`;
                    }
                    
                    if (expectedMessage === testCase.expected) {
                        log(`‚úÖ Error case ${index + 1}: Correct message generated`, 'success');
                    } else {
                        log(`‚ùå Error case ${index + 1}: Expected "${testCase.expected}", got "${expectedMessage}"`, 'error');
                    }
                });
                
            } catch (error) {
                log(`‚ùå Duplicate error test failed: ${error.message}`, 'error');
            }
        }

        // Initialize test environment
        log('üöÄ TN Form Submit Test initialized', 'info');
        log('üìã Available functions: collectContactData, collectTeamData, collectManagerData, collectRaceDayData, buildTNPracticePayload, getClientTxId, submitTNForm', 'info');
        // Add global console command for quick selector testing
        window.testSelectors = () => {
            console.log('üîç DOM Selector Test Results:');
            console.log(`document.querySelectorAll('.teamName').length = ${document.querySelectorAll('.teamName').length}`);
            console.log(`document.querySelectorAll('.practiceTeam').length = ${document.querySelectorAll('.practiceTeam').length}`);
            
            const practiceTeams = document.querySelectorAll('.practiceTeam');
            const validPracticeTeams = Array.from(practiceTeams).filter(team => 
                team.querySelectorAll('.prefRow').length > 0 && 
                team.querySelectorAll('.slotRank').length > 0
            );
            console.log(`Valid practice teams (with both .prefRow and .slotRank): ${validPracticeTeams.length}`);
            
            return {
                teamNameCount: document.querySelectorAll('.teamName').length,
                practiceTeamCount: document.querySelectorAll('.practiceTeam').length,
                validPracticeTeamCount: validPracticeTeams.length
            };
        };
    </script>
</body>
</html>
