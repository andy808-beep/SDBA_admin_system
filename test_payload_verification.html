<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payload Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .log { background: #f8f9fa; padding: 10px; border-left: 4px solid #007bff; margin: 10px 0; }
        .error-log { border-left-color: #dc3545; }
        .success-log { border-left-color: #28a745; }
    </style>
</head>
<body>
    <h1>üß™ Payload Verification Test</h1>
    
    <div class="test-section info">
        <h3>Test Instructions</h3>
        <p>This test verifies the payload structure and form submission:</p>
        <ol>
            <li><strong>Build Payload:</strong> Click "Build Payload" to generate a test payload</li>
            <li><strong>Verify Shape:</strong> Check the payload structure matches expected format</li>
            <li><strong>Submit Form:</strong> Test the actual form submission</li>
            <li><strong>Check Results:</strong> Verify network call and localStorage</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="buildTestPayload()">Build Payload</button>
        <button onclick="submitTestForm()">Test Form (Simulated)</button>
        <button onclick="testRealSubmission()">Test Real Submission</button>
        <button onclick="testEdgeFunctionHealth()">Test Edge Function Health</button>
        <button onclick="clearTestData()">Clear Test Data</button>
        <button onclick="clearDatabaseTestData()">Clear DB Test Data</button>
        <button onclick="checkLocalStorage()">Check localStorage</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="logs"></div>

    <script>
        // Mock configuration
        window.__CONFIG = {
            event: {
                event_short_ref: 'TN2025',
                season: 2025,
                form_enabled: true
            }
        };

        // Mock localStorage data for testing
        function setupMockData() {
            localStorage.setItem('race_category', 'mixed_open');
            localStorage.setItem('org_name', 'Test Organization');
            localStorage.setItem('org_address', '123 Test Street, Test City');
            localStorage.setItem('num_teams', '1');
            localStorage.setItem('num_teams_opt1', '1');
            localStorage.setItem('num_teams_opt2', '0');
            localStorage.setItem('team_names', JSON.stringify(['Test Team 1']));
            localStorage.setItem('team_options', JSON.stringify(['opt1']));
            localStorage.setItem('managers', JSON.stringify([
                { name: 'Manager 1', mobile: '12345678', email: 'manager1@test.com' },
                { name: 'Manager 2', mobile: '87654321', email: 'manager2@test.com' },
                { name: 'Manager 3', mobile: '11223344', email: 'manager3@test.com' }
            ]));
            localStorage.setItem('race_day_arrangement', JSON.stringify({
                marqueeQty: 1,
                steerWithQty: 2,
                steerWithoutQty: 1,
                junkBoatQty: 0,
                speedboatQty: 1,
                junkBoatNo: 'J001',
                speedBoatNo: 'S001'
            }));
            
            // Mock practice data for TN format
            const practiceData = {
                teams: [
                    {
                        team_key: 't1',
                        dates: [
                            { pref_date: '2025-01-15', duration_hours: 2, helper: 'ST' },
                            { pref_date: '2025-01-16', duration_hours: 1, helper: 'S' }
                        ],
                        slot_ranks: [
                            { rank: 1, slot_code: 'MORNING_1' },
                            { rank: 2, slot_code: 'AFTERNOON_1' },
                            { rank: 3, slot_code: 'EVENING_1' }
                        ]
                    }
                ]
            };
            localStorage.setItem('practiceData', JSON.stringify(practiceData));
        }

        // Client transaction ID generator
        function getClientTxId() {
            // Always generate a new unique ID for testing with maximum randomness
            const timestamp = Date.now();
            const microtime = performance.now(); // High precision timestamp
            const random1 = Math.random().toString(36).substr(2, 9);
            const random2 = Math.random().toString(36).substr(2, 9);
            const random3 = Math.random().toString(36).substr(2, 9);
            const random4 = Math.random().toString(36).substr(2, 9);
            const id = `test_${timestamp}_${Math.floor(microtime)}_${random1}_${random2}_${random3}_${random4}`;
            console.log('Generated new client_tx_id:', id);
            console.log('Timestamp:', timestamp, 'Microtime:', microtime);
            // Don't store in localStorage to ensure fresh ID every time
            return id;
        }

        // Build payload function that matches the expected format
        function buildPayload() {
            // Always generate fresh data for testing
            setupMockData();
            
            const category = localStorage.getItem("race_category");
            const managers = JSON.parse(localStorage.getItem("managers") || "[]");
            const teamNames = JSON.parse(localStorage.getItem("team_names") || "[]");
            const teamOptions = JSON.parse(localStorage.getItem("team_options") || "[]");
            const raceDayData = JSON.parse(localStorage.getItem("race_day_arrangement") || "null");
            const practiceData = JSON.parse(localStorage.getItem("practiceData") || "null");

            // Convert team options to the expected format
            const team_options = teamOptions.map(opt => opt === 'opt1' ? 'opt1' : 'opt2');

            // Build race day object
            const race_day = raceDayData ? {
                marqueeQty: raceDayData.marqueeQty || 0,
                steerWithQty: raceDayData.steerWithQty || 0,
                steerWithoutQty: raceDayData.steerWithoutQty || 0,
                junkBoatNo: raceDayData.junkBoatNo || null,
                junkBoatQty: raceDayData.junkBoatQty || 0,
                speedBoatNo: raceDayData.speedBoatNo || null,
                speedboatQty: raceDayData.speedboatQty || 0
            } : null;

            const clientTxId = getClientTxId();
            console.log('Building payload with client_tx_id:', clientTxId);

            return {
                eventShortRef: window.__CONFIG?.event?.event_short_ref || 'TN2025',
                category: category,
                season: window.__CONFIG?.event?.season || 2025,
                org_name: localStorage.getItem("org_name"),
                org_address: localStorage.getItem("org_address"),
                counts: {
                    num_teams: Number(localStorage.getItem("num_teams")) || 0,
                    num_teams_opt1: Number(localStorage.getItem("num_teams_opt1")) || 0,
                    num_teams_opt2: Number(localStorage.getItem("num_teams_opt2")) || 0
                },
                team_names: teamNames,
                team_options: team_options,
                managers: managers,
                race_day: race_day,
                practice: practiceData,
                client_tx_id: clientTxId
            };
        }

        // Expose buildPayload globally for console testing
        window.buildPayload = buildPayload;

        // Test functions
        function buildTestPayload() {
            setupMockData();
            const payload = buildPayload();
            
            log('üì¶ Generated Payload:', 'info');
            log(JSON.stringify(payload, null, 2), 'info');
            
            // Verify payload structure
            const requiredFields = ['eventShortRef', 'category', 'season', 'org_name', 'counts', 'team_names', 'team_options', 'managers', 'client_tx_id'];
            const missingFields = requiredFields.filter(field => !(field in payload));
            
            if (missingFields.length === 0) {
                log('‚úÖ All required fields present', 'success');
            } else {
                log(`‚ùå Missing fields: ${missingFields.join(', ')}`, 'error');
            }
            
            // Verify practice.teams structure
            if (payload.practice && payload.practice.teams) {
                log('‚úÖ Practice.teams structure found', 'success');
                log(`   - Number of teams: ${payload.practice.teams.length}`, 'info');
                payload.practice.teams.forEach((team, index) => {
                    log(`   - Team ${index + 1}: ${team.team_key}, ${team.dates?.length || 0} dates, ${team.slot_ranks?.length || 0} slot ranks`, 'info');
                });
            } else {
                log('‚ö†Ô∏è No practice.teams structure found', 'error');
            }
            
            // Verify team counts match
            const expectedTeams = payload.counts.num_teams;
            const actualTeams = payload.team_names.length;
            if (expectedTeams === actualTeams) {
                log(`‚úÖ Team count matches: ${actualTeams} teams`, 'success');
            } else {
                log(`‚ùå Team count mismatch: expected ${expectedTeams}, got ${actualTeams}`, 'error');
            }
        }

        async function submitTestForm() {
            try {
                const payload = buildPayload();
                log('üöÄ Testing form submission...', 'info');
                log('Payload structure verified:', 'success');
                log(JSON.stringify(payload, null, 2), 'info');
                
                // For now, just simulate the submission and save to localStorage
                // In a real test, you would call the actual Supabase function
                log('üìù Simulating successful submission...', 'info');
                
                // Simulate response data
                const mockResponse = {
                    registration_ids: ['reg_' + Date.now() + '_1', 'reg_' + Date.now() + '_2'],
                    team_codes: ['S25-X001', 'S25-X002']
                };
                
                log('‚úÖ Simulated response:', 'success');
                log(JSON.stringify(mockResponse, null, 2), 'success');
                
                // Save to localStorage
                localStorage.setItem('raceApp:lastSubmit', JSON.stringify({
                    timestamp: Date.now(),
                    registration_ids: mockResponse.registration_ids,
                    team_codes: mockResponse.team_codes,
                    payload: payload
                }));
                
                log('‚úÖ Data saved to localStorage', 'success');
                log('üí° To test actual submission, use the main form or call the Supabase function directly', 'info');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testRealSubmission() {
            try {
                // First, check if there are existing records with the same client_tx_id
                const payload = buildPayload();
                log('üöÄ Testing REAL Supabase submission...', 'info');
                log('Payload:', 'info');
                log(JSON.stringify(payload, null, 2), 'info');
                log(`Client TX ID: ${payload.client_tx_id}`, 'info');
                log(`Client TX ID length: ${payload.client_tx_id.length}`, 'info');
                log(`Client TX ID type: ${typeof payload.client_tx_id}`, 'info');
                
                // Check if this combination already exists in the database
                log('üîç Checking for existing records with same event_short_ref + client_tx_id...', 'info');
                try {
                    const checkResponse = await fetch(`https://khqarcvszewerjckmtpg.supabase.co/rest/v1/registration_meta?event_short_ref=eq.${payload.eventShortRef}&client_tx_id=eq.${payload.client_tx_id}&select=id,event_short_ref,client_tx_id,team_name`, {
                        headers: {
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtocWFyY3ZzemV3ZXJqY2ttdHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NTE5MTEsImV4cCI6MjA2NDMyNzkxMX0.d8_q1aI_I5pwNf73FIKxNo8Ok0KNxzF-SGDGegpRwbY',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtocWFyY3ZzemV3ZXJqY2ttdHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NTE5MTEsImV4cCI6MjA2NDMyNzkxMX0.d8_q1aI_I5pwNf73FIKxNo8Ok0KNxzF-SGDGegpRwbY'
                        }
                    });
                    
                    if (checkResponse.ok) {
                        const existingRecords = await checkResponse.json();
                        if (existingRecords.length > 0) {
                            log(`‚ö†Ô∏è Found ${existingRecords.length} existing records with same event_short_ref + client_tx_id!`, 'error');
                            log('Existing records:', 'error');
                            log(JSON.stringify(existingRecords, null, 2), 'error');
                            log('This will cause a duplicate key error. Generating new ID...', 'info');
                            
                            // Generate a completely new ID
                            const newTimestamp = Date.now() + Math.random() * 1000;
                            const newMicrotime = performance.now();
                            const newRandom1 = Math.random().toString(36).substr(2, 9);
                            const newRandom2 = Math.random().toString(36).substr(2, 9);
                            const newRandom3 = Math.random().toString(36).substr(2, 9);
                            const newRandom4 = Math.random().toString(36).substr(2, 9);
                            payload.client_tx_id = `test_${newTimestamp}_${Math.floor(newMicrotime)}_${newRandom1}_${newRandom2}_${newRandom3}_${newRandom4}`;
                            log(`New Client TX ID: ${payload.client_tx_id}`, 'info');
                        } else {
                            log('‚úÖ No existing records found, proceeding with submission', 'success');
                        }
                    } else {
                        log('‚ö†Ô∏è Could not check existing records, proceeding anyway', 'info');
                    }
                } catch (checkError) {
                    log(`‚ö†Ô∏è Could not check existing records: ${checkError.message}`, 'info');
                }
                
                // Continue with the submission
                const supabaseUrl = 'https://khqarcvszewerjckmtpg.supabase.co';
                const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtocWFyY3ZzemV3ZXJqY2ttdHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NTE5MTEsImV4cCI6MjA2NDMyNzkxMX0.d8_q1aI_I5pwNf73FIKxNo8Ok0KNxzF-SGDGegpRwbY';
                
                log('üîë Using configured Supabase credentials', 'info');
                
                const response = await fetch(`${supabaseUrl}/functions/v1/submit_registration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${anonKey}`,
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ REAL submission successful! Status: ${response.status}`, 'success');
                    log('Response data:', 'success');
                    log(JSON.stringify(data, null, 2), 'success');
                    
                    // Check if registration_ids and team_codes are returned
                    if (data.registration_ids && data.team_codes) {
                        log(`‚úÖ Registration IDs: ${data.registration_ids.length}`, 'success');
                        log(`‚úÖ Team Codes: ${data.team_codes.join(', ')}`, 'success');
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('raceApp:lastSubmit', JSON.stringify({
                        timestamp: Date.now(),
                        registration_ids: data.registration_ids,
                        team_codes: data.team_codes,
                        payload: payload
                    }));
                    
                    log('‚úÖ Data saved to localStorage', 'success');
                    
                } else {
                    log(`‚ùå REAL submission failed! Status: ${response.status}`, 'error');
                    try {
                        const errorText = await response.text();
                        log('Raw error response:', 'error');
                        log(errorText, 'error');
                        
                        // Try to parse as JSON
                        try {
                            const errorData = JSON.parse(errorText);
                            log('Parsed error data:', 'error');
                            log(JSON.stringify(errorData, null, 2), 'error');
                        } catch (parseError) {
                            log('Error response is not valid JSON', 'error');
                        }
                    } catch (e) {
                        log(`Could not read error response: ${e.message}`, 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
            }
        }

        function checkLocalStorage() {
            log('üîç Checking localStorage...', 'info');
            
            const lastSubmit = localStorage.getItem('raceApp:lastSubmit');
            if (lastSubmit) {
                log('‚úÖ raceApp:lastSubmit found:', 'success');
                log(JSON.stringify(JSON.parse(lastSubmit), null, 2), 'success');
            } else {
                log('‚ùå raceApp:lastSubmit not found', 'error');
            }
            
            const clientTxId = localStorage.getItem('raceApp:client_tx_id');
            if (clientTxId) {
                log(`‚úÖ Client TX ID: ${clientTxId}`, 'success');
            } else {
                log('‚ùå Client TX ID not found', 'error');
            }
        }

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type === 'error' ? 'error-log' : type === 'success' ? 'success-log' : ''}`;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearTestData() {
            // Clear all test-related localStorage data
            localStorage.removeItem('raceApp:client_tx_id');
            localStorage.removeItem('raceApp:lastSubmit');
            localStorage.removeItem('race_category');
            localStorage.removeItem('org_name');
            localStorage.removeItem('org_address');
            localStorage.removeItem('num_teams');
            localStorage.removeItem('num_teams_opt1');
            localStorage.removeItem('num_teams_opt2');
            localStorage.removeItem('team_names');
            localStorage.removeItem('team_options');
            localStorage.removeItem('managers');
            localStorage.removeItem('race_day_arrangement');
            localStorage.removeItem('practiceData');
            
            // Clear any other potential test data
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('raceApp:') || key.startsWith('test_')) {
                    localStorage.removeItem(key);
                }
            });
            
            log('üßπ Test data cleared from localStorage', 'success');
            log('üí° Click "Build Payload" to generate fresh test data', 'info');
        }

        async function clearDatabaseTestData() {
            try {
                log('üßπ Clearing test data from database...', 'info');
                const supabaseUrl = 'https://khqarcvszewerjckmtpg.supabase.co';
                const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtocWFyY3ZzemV3ZXJqY2ttdHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NTE5MTEsImV4cCI6MjA2NDMyNzkxMX0.d8_q1aI_I5pwNf73FIKxNo8Ok0KNxzF-SGDGegpRwbY';
                
                // Delete all test records
                const response = await fetch(`${supabaseUrl}/rest/v1/registration_meta?client_tx_id=like.test_*`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': anonKey,
                        'Authorization': `Bearer ${anonKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Test data cleared from database', 'success');
                } else {
                    log('‚ö†Ô∏è Could not clear database (this is normal if no test data exists)', 'info');
                }
            } catch (error) {
                log(`‚ö†Ô∏è Could not clear database: ${error.message}`, 'info');
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testEdgeFunctionHealth() {
            try {
                log('üè• Testing Edge Function health...', 'info');
                const supabaseUrl = 'https://khqarcvszewerjckmtpg.supabase.co';
                const anonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtocWFyY3ZzemV3ZXJqY2ttdHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NTE5MTEsImV4cCI6MjA2NDMyNzkxMX0.d8_q1aI_I5pwNf73FIKxNo8Ok0KNxzF-SGDGegpRwbY';
                
                // Test with a minimal payload
                const testPayload = {
                    eventShortRef: 'TN2025',
                    category: 'mixed_open',
                    org_name: 'Health Check',
                    counts: { num_teams: 1, num_teams_opt1: 1, num_teams_opt2: 0 },
                    team_names: ['Health Check Team'],
                    team_options: ['opt1'],
                    managers: [{ name: 'Test Manager', mobile: '1234567890', email: 'test@example.com' }],
                    client_tx_id: `health_check_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
                };
                
                log('Test payload:', 'info');
                log(JSON.stringify(testPayload, null, 2), 'info');
                
                const response = await fetch(`${supabaseUrl}/functions/v1/submit_registration`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${anonKey}`,
                    },
                    body: JSON.stringify(testPayload)
                });
                
                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`Response headers: ${JSON.stringify([...response.headers.entries()])}`, 'info');
                
                const responseText = await response.text();
                log('Response body:', 'info');
                log(responseText, 'info');
                
                if (response.ok) {
                    log('‚úÖ Edge Function is healthy!', 'success');
                } else {
                    log('‚ùå Edge Function returned error', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Health check failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üöÄ Payload Verification Test initialized', 'info');
        log('üí° Use console: await window.buildPayload().then(p=>console.log(p))', 'info');
        log('üí° Or click "Build Payload" button above', 'info');
        log('üí° Click "Clear Test Data" if you get duplicate key errors', 'info');
    </script>
</body>
</html>
