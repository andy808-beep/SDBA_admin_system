<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Events Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; }
    .info { background-color: #d1ecf1; border-color: #bee5eb; }
    .event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    .event-card { border: 1px solid #ddd; padding: 15px; cursor: pointer; }
    .event-card:hover { background-color: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Dynamic Events Test</h1>
  <div id="status">Testing dynamic event loading...</div>
  
  <div class="test-section" id="test1">
    <h3>Test 1: Database Event Loading</h3>
    <div id="test1-result">Testing...</div>
  </div>
  
  <div class="test-section" id="test2">
    <h3>Test 2: Fallback Event Loading</h3>
    <div id="test2-result">Testing...</div>
  </div>
  
  <div class="test-section" id="test3">
    <h3>Test 3: Event Rendering</h3>
    <div id="test3-result">Testing...</div>
    <div id="eventGrid" class="event-grid"></div>
  </div>
  
  <script src="env.js"></script>
  <script type="module">
    import { sb } from './supabase_config.js';
    
    async function fetchEvents() {
      const { data, error } = await sb
        .from('annual_event_config')
        .select('event_short_ref, event_long_name_en, event_date_en, event_date, event_location_en, form_enabled')
        .eq('form_enabled', true)
        .order('event_date', { ascending: true });
      if (error) throw error;
      return data || [];
    }
    
    function escapeHtml(text) {
      return String(text ?? '').replace(/[&<>"']/g, s => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[s]));
    }
    
    function renderEventCards(events) {
      const grid = document.getElementById('eventGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      events.forEach((event, index) => {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.onclick = () => {
          console.log('Event clicked:', event.ref);
          document.getElementById('test3-result').innerHTML = `Selected: ${event.name}`;
        };
        
        card.innerHTML = `
          <h3>${escapeHtml(event.name)}</h3>
          <p>${escapeHtml(event.description)}</p>
          <div class="description">${escapeHtml(event.details)}</div>
        `;
        
        grid.appendChild(card);
      });
    }
    
    async function testDatabaseEvents() {
      try {
        console.log('üß™ Test 1: Testing database event loading...');
        const dbEvents = await fetchEvents();
        
        if (dbEvents && dbEvents.length > 0) {
          document.getElementById('test1-result').innerHTML = `‚úÖ Loaded ${dbEvents.length} events from database`;
          document.getElementById('test1').className = 'test-section success';
          return dbEvents;
        } else {
          document.getElementById('test1-result').innerHTML = '‚ö†Ô∏è No events found in database';
          document.getElementById('test1').className = 'test-section info';
          return null;
        }
      } catch (error) {
        document.getElementById('test1-result').innerHTML = `‚ö†Ô∏è Database loading failed: ${error.message}`;
        document.getElementById('test1').className = 'test-section info';
        return null;
      }
    }
    
    function testFallbackEvents() {
      try {
        console.log('üß™ Test 2: Testing fallback event loading...');
        
        const fallbackEvents = [
          {
            ref: 'tn',
            name: 'TN Dragon Boat Race',
            description: 'Traditional Dragon Boat Race',
            details: 'Multi-step registration form with practice booking calendar. Includes team registration, race day arrangements, and practice scheduling.'
          },
          {
            ref: 'wu',
            name: 'WU Dragon Boat Race', 
            description: 'Water University Dragon Boat Race',
            details: 'Modern single-page registration form with configurable options. Streamlined registration process with dynamic form fields.'
          },
          {
            ref: 'sc',
            name: 'SC Dragon Boat Race',
            description: 'Sports Club Dragon Boat Race', 
            details: 'Modern single-page registration form with configurable options. Streamlined registration process with dynamic form fields.'
          }
        ];
        
        document.getElementById('test2-result').innerHTML = `‚úÖ Created ${fallbackEvents.length} fallback events`;
        document.getElementById('test2').className = 'test-section success';
        return fallbackEvents;
      } catch (error) {
        document.getElementById('test2-result').innerHTML = `‚ùå Fallback event creation failed: ${error.message}`;
        document.getElementById('test2').className = 'test-section error';
        return null;
      }
    }
    
    async function testEventRendering(events) {
      try {
        console.log('üß™ Test 3: Testing event rendering...');
        
        if (!events || events.length === 0) {
          document.getElementById('test3-result').innerHTML = '‚ùå No events to render';
          document.getElementById('test3').className = 'test-section error';
          return false;
        }
        
        renderEventCards(events);
        document.getElementById('test3-result').innerHTML = `‚úÖ Rendered ${events.length} event cards`;
        document.getElementById('test3').className = 'test-section success';
        return true;
      } catch (error) {
        document.getElementById('test3-result').innerHTML = `‚ùå Event rendering failed: ${error.message}`;
        document.getElementById('test3').className = 'test-section error';
        return false;
      }
    }
    
    async function runAllTests() {
      console.log('üß™ Starting Dynamic Events Tests...');
      
      // Test 1: Try to load from database
      const dbEvents = await testDatabaseEvents();
      
      // Test 2: Create fallback events
      const fallbackEvents = testFallbackEvents();
      
      // Test 3: Use database events if available, otherwise fallback
      const eventsToRender = dbEvents || fallbackEvents;
      const renderingSuccess = await testEventRendering(eventsToRender);
      
      if (renderingSuccess) {
        document.getElementById('status').innerHTML = '‚úÖ Dynamic events test completed successfully!';
        document.getElementById('status').style.color = 'green';
      } else {
        document.getElementById('status').innerHTML = '‚ùå Dynamic events test failed. Check individual test results.';
        document.getElementById('status').style.color = 'red';
      }
      
      console.log('üß™ Dynamic Events Tests completed');
    }
    
    runAllTests();
  </script>
</body>
</html>
