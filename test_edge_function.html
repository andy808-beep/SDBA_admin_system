<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Edge Function</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Test Edge Function</h1>
    <button onclick="testEdgeFunction()">Test Edge Function</button>
    <button onclick="checkDatabase()">Check Database</button>
    <button onclick="testFormSubmission()">Test Form Submission</button>
    <div id="output"></div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://khqarcvszewerjckmtpg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtocWFyY3ZzemV3ZXJqY2ttdHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NTE5MTEsImV4cCI6MjA2NDMyNzkxMX0.d8_q1aI_I5pwNf73FIKxNo8Ok0KNxzF-SGDGegpRwbY';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        async function checkDatabase() {
            log('üîç Checking database views...');
            
            try {
                // Check if v_event_config_public exists
                const { data: eventConfig, error: eventError } = await supabase
                    .from('v_event_config_public')
                    .select('*')
                    .eq('event_short_ref', 'TN2025')
                    .single();
                
                if (eventError) {
                    log('‚ùå v_event_config_public error: ' + eventError.message);
                } else {
                    log('‚úÖ v_event_config_public data: ' + JSON.stringify(eventConfig, null, 2));
                }
            } catch (e) {
                log('‚ùå Database check failed: ' + e.message);
            }
        }

        async function testEdgeFunction() {
            log('üöÄ Testing Edge Function...');
            
            const testPayload = {
                client_tx_id: 'test_' + Date.now(),
                eventShortRef: 'TN2025',
                category: 'mixed_open',
                season: 2025,
                org_name: 'Test Organization',
                org_address: '123 Test Street',
                counts: {
                    num_teams: 1,
                    num_teams_opt1: 1,
                    num_teams_opt2: 0
                },
                team_names: ['Test Team Alpha'],
                team_options: ['opt1'],
                managers: [
                    {
                        name: 'John Doe',
                        mobile: '1234567890',
                        email: 'john@test.com'
                    }
                ],
                race_day: {
                    teams: [
                        {
                            team_key: 't1',
                            equipment: 'basic',
                            tshirt: 'M',
                            shorts: 'M',
                            dry_bag: '1'
                        }
                    ]
                },
                practice: {
                    teams: [
                        {
                            team_key: 't1',
                            dates: [
                                { pref_date: '2025-01-15', duration_hours: 2, helper: 'S' },
                                { pref_date: '2025-01-22', duration_hours: 1, helper: 'T' }
                            ],
                            slot_ranks: [
                                { rank: 1, slot_code: 'SAT2_0800_1000' },
                                { rank: 2, slot_code: 'SAT2_1000_1200' }
                            ]
                        }
                    ]
                }
            };

            try {
                const { data, error } = await supabase.functions.invoke('submit_registration', {
                    body: testPayload
                });

                if (error) {
                    log('‚ùå Edge Function error: ' + JSON.stringify(error, null, 2));
                    log('‚ùå Error details: ' + error.message);
                    log('‚ùå Error context: ' + JSON.stringify(error.context, null, 2));
                } else {
                    log('‚úÖ Edge Function success: ' + JSON.stringify(data, null, 2));
                }
            } catch (e) {
                log('‚ùå Edge Function failed: ' + e.message);
                log('‚ùå Error stack: ' + e.stack);
            }
        }

        async function testFormSubmission() {
            log('üöÄ Testing Form Submission...');
            
            // Open the form in a new window and run fillAllSteps
            const formWindow = window.open('http://localhost:8001/register.html', '_blank');
            
            // Wait a bit for the form to load
            setTimeout(() => {
                try {
                    formWindow.fillAllSteps();
                    log('‚úÖ Form opened and fillAllSteps() called');
                    log('üéØ Check the form window - it should be on the summary page with complete data');
                    log('üéØ Click Submit in the form window to test the actual submission');
                } catch (e) {
                    log('‚ùå Error calling fillAllSteps: ' + e.message);
                }
            }, 2000);
        }
    </script>
</body>
</html>
