{
  "version": 3,
  "sources": [],
  "debugId": "cc797a14-9cf5-e498-7581-c0a17ceb1856",
  "sections": [
    {"offset": {"line": 5, "column": 0}, "map": {"version":3,"sources":["file:///Users/andywang/Desktop/SDBA_admin_system-1/lib/instrumentation/server.ts"],"sourcesContent":["// lib/instrumentation/server.ts\n// Server-side Sentry instrumentation for API and database tracking\n// NOTE: This file should only be imported in Node.js runtime (API routes, not middleware)\n\n// Conditional import to avoid Edge Runtime issues\nlet Sentry: typeof import(\"@sentry/nextjs\") | null = null;\n\nasync function getSentry() {\n  if (!Sentry && typeof window === \"undefined\") {\n    try {\n      Sentry = await import(\"@sentry/nextjs\");\n    } catch (error) {\n      // Sentry not available (e.g., in test environment)\n      return null;\n    }\n  }\n  return Sentry;\n}\n\n/**\n * Track API route performance\n * Wraps an API route handler to automatically track performance\n */\nexport function withApiPerformanceTracking<T extends (...args: any[]) => Promise<any>>(\n  handler: T,\n  routeName: string\n): T {\n  return (async (...args: Parameters<T>) => {\n    const sentry = await getSentry();\n    if (!sentry) {\n      // Sentry not available, just run handler\n      return handler(...args);\n    }\n    \n    // Use startSpan instead of deprecated startTransaction\n    return sentry.startSpan(\n      {\n        name: routeName,\n        op: \"http.server\",\n        attributes: {\n          route: routeName,\n        },\n      },\n      async (span) => {\n        try {\n          const result = await handler(...args);\n          span?.setStatus({ code: 1, message: \"ok\" }); // 1 = OK\n          return result;\n        } catch (error) {\n          span?.setStatus({ code: 2, message: \"internal_error\" }); // 2 = ERROR\n          throw error;\n        }\n      }\n    );\n  }) as T;\n}\n\n/**\n * Track database query performance\n * Wraps a database operation to track its performance\n */\nexport async function trackDatabaseQuery<T>(\n  operation: () => Promise<T>,\n  operationName: string,\n  tableName?: string\n): Promise<T> {\n  const sentry = await getSentry();\n  if (!sentry) {\n    // Sentry not available, just run operation\n    return operation();\n  }\n  \n  const span = sentry.startSpan(\n    {\n      op: \"db.query\",\n      name: operationName,\n      attributes: {\n        table: tableName,\n        operation: operationName,\n      },\n    },\n    async () => {\n      try {\n        const result = await operation();\n        return result;\n      } catch (error) {\n        sentry.captureException(error, {\n          tags: {\n            operation: operationName,\n            table: tableName || \"unknown\",\n            error_type: \"database_error\",\n          },\n        });\n        throw error;\n      }\n    }\n  );\n\n  return span as T;\n}\n\n/**\n * Track RPC function calls\n */\nexport async function trackRpcCall<T extends { data: any; error: any }>(\n  rpcFunction: () => Promise<T>,\n  functionName: string,\n  params?: Record<string, any>\n): Promise<T> {\n  const sentry = await getSentry();\n  if (!sentry) {\n    // Sentry not available, just run function\n    return rpcFunction();\n  }\n  \n  return sentry.startSpan(\n    {\n      op: \"db.rpc\",\n      name: functionName,\n      attributes: {\n        function: functionName,\n        params: params ? JSON.stringify(params) : undefined,\n      },\n    },\n    async () => {\n      try {\n        const result = await rpcFunction();\n        return result;\n      } catch (error) {\n        sentry.captureException(error, {\n          tags: {\n            function: functionName,\n            error_type: \"rpc_error\",\n          },\n          extra: {\n            params,\n          },\n        });\n        throw error;\n      }\n    }\n  ) as Promise<T>;\n}\n\n/**\n * Track registration approval/rejection events\n */\nexport async function trackRegistrationEvent(\n  eventType: \"approve\" | \"reject\",\n  registrationId: string,\n  adminUserId: string,\n  success: boolean,\n  error?: Error\n) {\n  try {\n    const sentry = await getSentry();\n    if (!sentry) {\n      return; // Sentry not available\n    }\n    \n    sentry.addBreadcrumb({\n      category: \"registration\",\n      message: `Registration ${eventType}: ${registrationId}`,\n      level: success ? \"info\" : \"error\",\n      data: {\n        event_type: eventType,\n        registration_id: registrationId,\n        admin_user_id: adminUserId,\n        success,\n      },\n    });\n\n    if (!success && error) {\n      sentry.captureException(error, {\n        tags: {\n          event_type: eventType,\n          operation: \"registration_management\",\n        },\n        extra: {\n          registration_id: registrationId,\n          admin_user_id: adminUserId,\n        },\n      });\n    }\n  } catch (err) {\n    // Silently fail if Sentry is not initialized\n    // This can happen in test environments or if Sentry is not configured\n  }\n}\n\n/**\n * Track authentication failures\n */\nexport async function trackAuthFailure(\n  reason: string,\n  userId?: string,\n  email?: string\n) {\n  try {\n    const sentry = await getSentry();\n    if (!sentry) {\n      return; // Sentry not available\n    }\n    \n    sentry.addBreadcrumb({\n      category: \"auth\",\n      message: `Authentication failure: ${reason}`,\n      level: \"warning\",\n      data: {\n        reason,\n        user_id: userId,\n        email,\n      },\n    });\n\n    // Don't send to Sentry as an error (expected behavior)\n    // Just log as breadcrumb for context\n  } catch (error) {\n    // Silently fail if Sentry is not initialized\n    // This can happen in test environments or if Sentry is not configured\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}